name: 05 Smart Multi-Stage CI/CD

on:
  push:

permissions:
  contents: read

env:
  DOTNET_VERSION: '9.0.x'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore
        run: dotnet restore

      - name: Build (Release)
        run: dotnet build -c Release --no-restore

      - name: Use my secret
        run: |
          echo "Min secret är tillgänglig (maskeras i loggar)."
          echo "Secret length: ${#MY_SECRET}"
        env:
          MY_SECRET: ${{ secrets.PROD_API_KEY }}

  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Run tests
        run: dotnet test -c Release --no-build --logger "trx;LogFileName=test_results.trx"

  deploy-dev:
    runs-on: ubuntu-latest
    needs: test
    if: needs.test.result == 'success'
    environment:
      name: dev
    env:
      SERVICE_NAME: ${{ vars.SERVICE_NAME }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - name: Publish
        run: dotnet publish MyService.Api/MyService.Api.csproj -c Release -o ./out
      - name: Simulate DEV deploy
        run: |
          echo "Deploying $SERVICE_NAME to DEV..."
          ls -la ./out
          echo "✅ Deployment completed successfully"

  deploy-prod:
    runs-on: ubuntu-latest
    needs: test
    if: needs.test.result == 'success' && github.ref == 'refs/heads/main'
    environment:
      name: prod
    env:
      SERVICE_NAME: ${{ vars.SERVICE_NAME }}
      PROD_API_KEY: ${{ secrets.PROD_API_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      - name: Mask secret
        run: echo "::add-mask::$PROD_API_KEY"
      - name: Debug (masked)
        run: echo "Using PROD key: $PROD_API_KEY"
      - name: Publish
        run: dotnet publish MyService.Api/MyService.Api.csproj -c Release -o ./out
      - name: Simulate PROD deploy
        run: |
          echo "Deploying $SERVICE_NAME to PROD with key $PROD_API_KEY..."
          ls -la ./out
          echo "✅ Deployment completed successfully"
